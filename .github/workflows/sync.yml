name: Daily Chromium Changed Files Only

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  extract-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4

      - name: Fetch Chromium Changes (Metadata Only)
        run: |
          mkdir chromium_temp
          cd chromium_temp
          git init
          git remote add upstream https://chromium.googlesource.com/chromium/src.git
          
          # Fetch 48 hours to ensure a valid history graph
          git fetch upstream main --filter=blob:none --shallow-since="48 hours ago"

      - name: Identify and Download Changed Files
        run: |
          cd chromium_temp
          
          # 1. Get raw list of all files touched in the last 24 hours
          git log --since="24 hours ago" --pretty="" --name-only --diff-filter=ACMRT upstream/main | sort -u > raw_changes.txt
          
          echo "Raw changed files count: $(wc -l < raw_changes.txt)"
          
          if [ ! -s raw_changes.txt ]; then
            echo "No changes found. Exiting."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # 2. FILTER: Keep only files that actually exist in upstream/main
          # We use xargs to pass the filenames to git ls-tree.
          # git ls-tree only outputs files that exist, effectively filtering out the deleted ones.
          # We use -r to recurse (though valid paths shouldn't need it, it's safer) and --name-only.
          
          cat raw_changes.txt | xargs -d '\n' git ls-tree -r --name-only upstream/main > valid_files.txt
          
          VALID_COUNT=$(wc -l < valid_files.txt)
          echo "Files valid for download: $VALID_COUNT"
          
          if [ "$VALID_COUNT" -eq "0" ]; then
             echo "All changed files were deleted. Nothing to download."
             echo "NO_CHANGES=true" >> $GITHUB_ENV
             exit 0
          fi

          # 3. Download only the verified existing files
          git restore --source=upstream/main --pathspec-from-file=valid_files.txt

      - name: Prepare Staging Area
        if: env.NO_CHANGES != 'true'
        run: |
          # Clean current directory (remove yesterday's files)
          find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name 'chromium_temp' -exec rm -rf {} +
          
          # Move new files
          rsync -av --exclude='.git' chromium_temp/ .
          rm -rf chromium_temp

      - name: Push to Repository
        if: env.NO_CHANGES != 'true'
        run: |
          git config --global user.name "Chromium Diff Bot"
          git config --global user.email "bot@example.com"
          git checkout --orphan latest-changes
          git add -A
          git commit -m "Chromium changes for $(date +'%Y-%m-%d')"
          git push origin latest-changes:main --force
