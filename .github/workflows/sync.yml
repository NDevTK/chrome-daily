name: Daily Chromium Changed Files Only

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  extract-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4

      - name: Fetch Chromium Changes (Metadata Only)
        run: |
          mkdir chromium_temp
          cd chromium_temp
          git init
          git remote add upstream https://chromium.googlesource.com/chromium/src.git
          
          # Fetch 48 hours to ensure we have a valid 'before' commit
          git fetch upstream main --filter=blob:none --shallow-since="48 hours ago"

      - name: Download Changed Files (Fast Method)
        run: |
          cd chromium_temp
          
          # 1. Find the commit SHA closest to 24 hours ago
          # This gives us a precise starting point for our diff
          START_SHA=$(git rev-list -n 1 --before="24 hours ago" upstream/main)
          
          if [ -z "$START_SHA" ]; then
             echo "Could not find a commit older than 24h (history too shallow?). using oldest available."
             START_SHA=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "Comparing upstream/main against commit: $START_SHA"

          # 2. Generate list using git diff (Instant)
          # -z: Use NULL separators (handles spaces/weird chars safely)
          # --name-only: filenames only
          # --diff-filter=ACMRT: Exclude deleted (D) files automatically
          git diff -z --name-only --diff-filter=ACMRT "$START_SHA" upstream/main > changed_files.txt
          
          # Check if file is empty (byte count)
          if [ ! -s changed_files.txt ]; then
             echo "No net changes found in the last 24h."
             echo "NO_CHANGES=true" >> $GITHUB_ENV
             exit 0
          fi

          # 3. Download the files
          # --pathspec-file-nul: Tells git to read the NULL-separated list we just made
          git restore --source=upstream/main --pathspec-from-file=changed_files.txt --pathspec-file-nul .

      - name: Prepare Staging Area
        if: env.NO_CHANGES != 'true'
        run: |
          # Wipe current repo (except git internals)
          find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name 'chromium_temp' -exec rm -rf {} +
          
          # Move files
          rsync -av --exclude='.git' chromium_temp/ .
          rm -rf chromium_temp

      - name: Push to Repository
        if: env.NO_CHANGES != 'true'
        run: |
          git config --global user.name "Chromium Diff Bot"
          git config --global user.email "bot@example.com"
          git checkout --orphan latest-changes
          git add -A
          git commit -m "Chromium changes for $(date +'%Y-%m-%d')"
          git push origin latest-changes:main --force
