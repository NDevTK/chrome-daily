name: Daily Chromium Changed Files Only

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  extract-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4

      - name: Fetch Chromium Changes (Metadata Only)
        run: |
          mkdir chromium_temp
          cd chromium_temp
          git init
          
          git remote add upstream https://chromium.googlesource.com/chromium/src.git
          
          # FIX 1: Fetch 48 hours instead of 24.
          # This creates a buffer so the 24h cutoff isn't the "root" of the history.
          echo "Fetching metadata..."
          git fetch upstream main --filter=blob:none --shallow-since="48 hours ago"

      - name: Identify and Download Changed Files
        run: |
          cd chromium_temp
          
          # List files changed in the last 24 hours
          # --diff-filter=ACMRT excludes Deleted files (D)
          # 'sort -u' ensures we don't download the same file twice if it changed multiple times
          git log --since="24 hours ago" --pretty="" --name-only --diff-filter=ACMRT upstream/main | sort -u > changed_files_list.txt
          
          COUNT=$(wc -l < changed_files_list.txt)
          echo "Found $COUNT files actually modified in the last 24 hours."
          
          if [ "$COUNT" -eq "0" ]; then
            echo "No changes found. Exiting."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # FIX 2: Removed the trailing "."
          # We use xargs strictly to batch the arguments if the list is too massive, 
          # though pathspec-from-file is usually safer.
          # However, pathspec-from-file + restore can sometimes be tricky with large lists in partial clones.
          # We will stick to pathspec-from-file but WITHOUT the trailing dot.
          
          git restore --source=upstream/main --pathspec-from-file=changed_files_list.txt

      - name: Prepare Staging Area
        if: env.NO_CHANGES != 'true'
        run: |
          # Clean the current directory (remove old files)
          find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name 'chromium_temp' -exec rm -rf {} +
          
          # Move files
          rsync -av --exclude='.git' chromium_temp/ .
          rm -rf chromium_temp

      - name: Push to Repository
        if: env.NO_CHANGES != 'true'
        run: |
          git config --global user.name "Chromium Diff Bot"
          git config --global user.email "bot@example.com"
          git checkout --orphan latest-changes
          git add -A
          git commit -m "Chromium changes for $(date +'%Y-%m-%d')"
          git push origin latest-changes:main --force
